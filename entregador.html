<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://*.firebaseio.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net; img-src 'self' data: https://*.tile.openstreetmap.org https://server.arcgisonline.com; connect-src 'self' wss://*.firebaseio.com https://viacep.com.br https://nominatim.openstreetmap.org https://router.project-osrm.org https://unpkg.com https://server.arcgisonline.com https://www.gstatic.com; worker-src 'self' blob:;"
    />
    <title>Painel Entregador - Scatambulo</title>

    <link
      href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/@maplibre/maplibre-gl-directions@0.7.1/dist/maplibre-gl-directions.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
  </head>
  <body>
    <header>
      <div class="header-container">
        <h1>Painel Entregador</h1>
        <div class="desktop-nav">
          <button id="scheduled-orders-button" class="btn-secondary">
            <i class="ph ph-calendar-check"></i> Ver Agendados
          </button>
          <button id="history-button" class="btn-secondary">
            <i class="ph ph-scroll"></i> Histórico
          </button>
          <button id="logout-button" class="btn-secondary">
            <i class="ph ph-sign-out"></i> Sair
          </button>
        </div>

        <button class="hamburger-menu" aria-label="Menu">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>
      </div>
    </header>

    <nav class="mobile-nav">
      <div class="mobile-nav-header">
        <h3>Menu</h3>
      </div>
      <!-- Os botões do desktop-nav serão movidos para cá em telas menores -->
    </nav>

    <!-- Dynamic Island -->
    <div id="dynamic-island-wrapper">
      <div
        id="dynamic-island"
        class="dynamic-island"
        tabindex="0"
        aria-label="Detalhes da entrega atual"
      >
        <div class="island-compact-view">
          <div class="island-icon">
            <i class="ph-fill ph-moped"></i>
          </div>
          <div class="island-content">
            <strong id="dynamic-island-client">Entregador</strong>
            <span id="dynamic-island-address">Aguardando entrega</span>
          </div>
        </div>
        <div class="island-expanded-content">
          <div class="expanded-details">
            <p>
              <strong>Bolo:</strong> <span id="expanded-island-item">--</span>
            </p>
            <p>
              <strong>Endereço:</strong>
              <span id="expanded-island-address">--</span>
            </p>
          </div>
          <div class="island-actions">
            <button
              id="dynamic-island-cancel-btn"
              class="btn-island-action btn-island-cancel"
            >
              <i class="ph ph-x"></i> Cancelar
            </button>
            <button
              id="dynamic-island-finish-btn"
              class="btn-island-action btn-island-finish"
            >
              <i class="ph ph-check"></i> Finalizar
            </button>
          </div>
        </div>
      </div>
    </div>

    <main class="container">
      <section id="map-section">
        <h2><i class="ph ph-map-pin"></i> Mapa de Entregas</h2>
        <div id="map-container">
          <div id="map"></div>
          <div class="map-interaction-overlay" id="map-overlay">
            <p>Clique para interagir com o mapa</p>
          </div>

          <div id="map-overlay-top" class="map-overlay-top-entregador">
            <div class="map-info-item map-info-item-border-right">
              <div id="distance-display" class="map-info-value">-- km</div>
              <div class="map-info-label">Distância</div>
            </div>
            <div class="map-info-item">
              <div id="eta-display" class="map-info-value">-- min</div>
              <div class="map-info-label">ETA</div>
            </div>
            <div class="map-info-item map-info-item-border-left">
              <div id="speed-display" class="map-info-value">-- km/h</div>
              <div class="map-info-label">Veloc.</div>
            </div>
          </div>

          <div id="nav-hud" class="nav-hud-entregador">
            <div class="hud-controls">
              <button
                id="map-fullscreen-btn"
                class="btn-secondary"
                title="Tela Cheia"
              >
                <i class="ph ph-arrows-out"></i>
              </button>
              <button
                id="follow-me-button"
                class="btn-secondary"
                title="Seguir Entregador"
                style="width: 44px; height: 44px; border-radius: 50%"
              >
                <i class="ph ph-compass"></i>
              </button>
              <button
                id="satellite-toggle"
                class="btn-secondary"
                title="Modo Satélite"
                style="width: 44px; height: 44px; border-radius: 50%"
              >
                <i class="ph ph-globe"></i>
              </button>
              <button
                id="toggle-3d"
                class="btn-secondary"
                title="Visualização 3D"
                style="width: 44px; height: 44px; border-radius: 50%"
              >
                <i class="ph ph-cube"></i>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="orders-section" style="margin-top: 30px">
        <div id="ready-for-delivery-container">
          <h3><i class="ph ph-package"></i> Prontos para Entrega</h3>
          <div id="ready-for-delivery-list"></div>
        </div>

        <h3 style="margin-top: 20px">
          <i class="ph ph-moped"></i> Em Rota (Outros)
        </h3>
        <div id="in-route-list"></div>
      </section>
    </main>

    <style>
      /* Estilos para a Dynamic Island com visual iOS */
      #dynamic-island-wrapper {
        position: fixed;
        top: 15px;
        left: 50%;
        transform: translateX(-50%) scale(0.95);
        transform-origin: top center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1),
          opacity 0.4s ease, visibility 0.4s;
      }
      #dynamic-island-wrapper.active {
        transform: translateX(-50%) scale(1);
        opacity: 1;
        visibility: visible;
      }

      .dynamic-island {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        background-color: #000;
        color: #fff;

        padding: 12px 16px;
        border-radius: 25px; /* Bordas bem arredondadas */

        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        transition: height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1),
          width 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);

        height: 64px;
        width: 95vw;
        max-width: 380px;
        box-sizing: border-box;
        cursor: pointer;
        overflow: hidden;
      }

      .dynamic-island.expanded {
        height: 180px; /* Altura expandida */
        cursor: default;
      }

      .island-compact-view {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
      }
      .island-icon {
        flex-shrink: 0;
        background-color: var(--primary-color);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .island-icon i {
        font-size: 18px;
        color: #fff;
      }

      .island-content {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
        flex-grow: 1;
        overflow: hidden;
      }
      .island-content strong {
        font-size: 15px;
        font-weight: 600;
      }
      .island-content span {
        font-size: 13px;
        color: #aaa;
      }

      .island-expanded-content {
        opacity: 0;
        transition: opacity 0.3s ease 0.1s;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        padding-top: 10px;
        justify-content: space-between;
      }

      .dynamic-island.expanded .island-expanded-content {
        opacity: 1;
      }

      .expanded-details p {
        margin: 0 0 4px;
        font-size: 14px;
        color: #ddd;
      }
      .expanded-details p strong {
        color: #fff;
      }

      .island-actions {
        display: flex;
        gap: 10px;
        margin-top: auto; /* Empurra para o fundo */
      }

      .btn-island-action {
        flex: 1;
        border: none;
        padding: 10px;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .btn-island-cancel {
        background-color: #555;
        color: #fff;
      }
      .btn-island-finish {
        background-color: var(--ios-green);
        color: #000;
      }

      /* Estilos para o Modal de Pedidos Agendados */
      .scheduled-day-group {
        background-color: #fff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      .scheduled-day-group h4 {
        font-size: 16px;
        color: #333;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
        text-transform: capitalize;
      }

      .order-row-scheduled {
        display: grid;
        grid-template-columns: 1.5fr 1.5fr 80px 2fr 85px;
        gap: 15px;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .order-row-scheduled:last-child {
        border-bottom: none;
      }

      .order-data-item-scheduled {
        font-size: 14px;
        color: #555;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .order-data-item-scheduled strong {
        color: #111;
        font-weight: 600;
      }
    </style>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script type="module" src="js/componentLoader.js"></script>
    <script type="module" src="js/entregador.js"></script>
  </body>
</html>
