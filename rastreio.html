<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Scatambulo" />
    <link rel="apple-touch-icon" href="/img/icons/apple-touch-icon.png" />
    <meta http-equiv="Content-Security-Policy"
      content="
    default-src 'self';
    frame-src https://*.firebaseio.com https://vercel.live;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.jsdelivr.net https://*.firebaseio.com https://www.gstatic.com https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://server.arcgisonline.com https://*.arcgisonline.com;
    font-src * data:;
    img-src 'self' data: https://*.tile.openstreetmap.org https://server.arcgisonline.com https://*.arcgisonline.com blob:;
    connect-src 'self' wss://*.firebaseio.com https://www.gstatic.com https://viacep.com.br https://nominatim.openstreetmap.org https://*.openstreetmap.org https://router.project-osrm.org https://unpkg.com https://server.arcgisonline.com https://*.arcgisonline.com blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
    worker-src 'self' blob:;
  ">
    <link
      href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      body {
        background-color: var(
          --cor-secundaria
        ); /* Cinza claro para combinar com o tema */
        padding-bottom: var(
          --safe-bottom
        ); /* Adiciona espa√ßo na parte inferior para a home bar do iOS */
      }
      .tracking-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 30px;
        background-color: var(--cor-principal);
        border-radius: var(--raio-borda-padrao, 12px);
        box-shadow: var(--sombra-card, 0 8px 24px rgba(0, 0, 0, 0.05));
        text-align: center;
      }
      .search-box {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      #order-code-input {
        flex-grow: 1;
        text-transform: uppercase;
      }
      #order-details-section {
        text-align: left;
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid var(--cor-borda-suave, #eee);
      }
      .status-timeline {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
      }
      .status-timeline::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 10%;
        right: 10%;
        height: 2px;
        background-color: var(--cor-borda-neutra, #e0e0e0);
        transform: translateY(-50%);
        z-index: 1;
      }
      .status-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        width: 80px;
      }
      .status-icon {
        width: 32px;
        height: 32px;
        margin-bottom: 8px;
        opacity: 0.3;
        transition: opacity 0.3s ease;
      }
      .status-step.active .status-icon,
      .status-step.completed .status-icon {
        opacity: 1;
      }

      /* Anima√ß√£o de pulso para o √≠cone ativo */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Aplica a anima√ß√£o ao √≠cone dentro do passo ativo, mas n√£o se for o √∫ltimo passo (entregue) */
      .status-step.active:not([data-status="entregue"]) .status-icon {
        animation: pulse 1.5s infinite;
      }

      .status-dot {
        width: 20px;
        height: 20px;
        background-color: var(--cor-borda-neutra, #e0e0e0);
        border-radius: 50%;
        margin-bottom: 8px;
        transition: background-color 0.3s ease;
      }
      .status-step.active .status-dot {
        background-color: var(--primary-color);
      }
      .status-step.completed .status-dot {
        background-color: var(--success-color);
      }
      .status-label {
        font-size: 0.8rem;
        color: var(--cor-texto-suave, #888);
      }
      .status-step.active .status-label,
      .status-step.completed .status-label {
        color: var(--cor-texto-principal, #333);
        font-weight: 600;
      }
      #map-container {
        height: 400px;
        border-radius: 8px;
        margin-top: 20px;
        position: relative; /* Necess√°rio para o overlay */
        border: 2px solid var(--cor-destaque);
        padding: 5px;
        background-color: var(--cor-destaque);
      }
      #rastreio-map {
        height: 100%;
        width: 100%;
        border-radius: 6px;
      }

      /* Estilos para o loading do mapa */
      .map-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #eef0f2;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 5;
        border-radius: 6px; /* Mesmo raio do mapa */
        transition: opacity 0.5s ease;
        opacity: 1;
        color: var(--cor-texto-secundario, #555);
        font-weight: 500;
      }
      .map-loading-overlay:not(.active) {
        opacity: 0;
        pointer-events: none;
      }
      .map-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #ccc;
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }
      .thank-you-card {
        text-align: center;
        margin-top: 20px;
        padding: 25px;
        background-color: #e8f5e9; /* Verde claro sucesso */
        border-radius: var(--raio-borda-padrao, 12px);
        color: #2e7d32; /* Verde escuro */
        border-left: 5px solid var(--cor-sucesso);
      }
      .thank-you-card h4 {
        margin: 0 0 10px 0;
        font-size: 1.5rem;
      }
      .thank-you-card p {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-container">
        <h1>Rastrear Pedido</h1>
        <nav>
          <a href="index.html" class="btn-secondary">Voltar</a>
        </nav>
      </div>
    </header>
    <main class="container">
      <div class="tracking-container">
        <h2>Insira o C√≥digo do Pedido</h2>
        <div class="search-box">
          <input
            type="text"
            id="order-code-input"
            placeholder="Ex: ABC123DE"
            maxlength="8"
          />
          <button id="track-order-button" class="btn-primary">Rastrear</button>
        </div>
        <p id="tracking-message" class="error-message"></p>

        <section id="order-details-section" style="display: none">
          <h3>
            Status do Pedido
            <span
              id="order-id-display"
              style="font-weight: 300; color: var(--ios-text-sec)"
            ></span>
          </h3>
          <div class="status-timeline">
            <div class="status-step" data-status="em_preparo">
              <img
                src="img/icons/EmPreparo.png"
                alt="Em Preparo"
                class="status-icon"
              />
              <span class="status-label">Em Preparo</span>
            </div>
            <div class="status-step" data-status="pronto_para_entrega">
              <img
                src="img/icons/pronto.png"
                alt="Pronto"
                class="status-icon"
              />
              <span class="status-label">Pronto</span>
            </div>
            <div class="status-step" data-status="em_entrega">
              <img
                src="img/icons/EmRota.png"
                alt="Em Rota"
                class="status-icon"
              />
              <span class="status-label">Em Rota</span>
            </div>
            <div class="status-step" data-status="entregue">
              <img
                src="img/icons/entregue.png"
                alt="Entregue"
                class="status-icon"
              />
              <span class="status-label">Entregue</span>
            </div>
          </div>

          <div class="order-info-card">
            <p><strong>Bolo:</strong> <span id="order-cake-name"></span></p>
            <p>
              <strong>Cliente:</strong> <span id="order-client-name"></span>
            </p>
          </div>

          <div id="thank-you-message" class="thank-you-card" style="display: none;">
            <h4>üéâ Pedido Entregue!</h4>
            <p>Agradecemos a sua prefer√™ncia. Volte sempre!</p>
          </div>

          <!-- O mapa ser√° exibido aqui quando o pedido estiver em rota -->
          <div id="map-container" style="display: none">
            <div class="map-loading-overlay active">
              <div class="map-spinner"></div>
              <span>Carregando mapa...</span>
            </div>
            <div id="rastreio-map"></div>
            <div class="map-interaction-overlay" id="map-overlay">
            </div>
            <!-- Bot√£o de Tela Cheia movido para o canto superior esquerdo -->
            <button
              id="map-fullscreen-btn"
              class="btn-secondary"
              title="Tela Cheia"
            >
              <i class="ph ph-arrows-out"></i>
            </button>
            <div id="nav-hud" class="nav-hud-rastreio">
              <div class="hud-controls"></div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script type="module" src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <!-- Importa o plugin MapLibre GL Directions como m√≥dulo e exp√µe globalmente -->
    <script type="module">
      import Directions from "https://unpkg.com/@maplibre/maplibre-gl-directions@0.7.1/dist/maplibre-gl-directions.js";
      window.MapLibreGlDirections = Directions.default || Directions;
    </script>

    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/firebase.js"></script>
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/map.js"></script>
    <script type="module" src="js/rastreio.js"></script>    
  </body>
</html>
